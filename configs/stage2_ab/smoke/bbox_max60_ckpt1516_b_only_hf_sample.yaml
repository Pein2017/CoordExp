# Backend-coverage smoke: Stage-2 AB Channel-B only (bbox-only max60, ckpt-1516),
# using HF generate() sampling path (tests sampling/seeding/parse robustness).
#
# NOTE: This intentionally differs from production only in rollout backend + decoding.
extends:
  - ../prod/b_only.yaml
  - common_prodlike.yaml

training:
  output_dir: output/stage2_ab/smoke_bbox_max60_ckpt1516/b_only_hf_sample
  logging_dir: .tb/stage2_ab/smoke_bbox_max60_ckpt1516/b_only_hf_sample
  run_name: smoke_bbox_max60_ckpt1516_b_only_hf_sample
  max_steps: 2

stage2_ab:
  channel_b:
    # HF backend smoke uses legacy step-budgeted mode to keep rollouts bounded.
    # NOTE: Because configs deep-merge, also null out the async subsection inherited
    # from prod/base.yaml.
    mode: step
    async: null
    # Pipeline requires vLLM server mode; disable for HF backend smoke.
    enable_pipeline: false
    # Keep smoke bounded: HF generate() is much slower than vLLM server decode.
    rollouts_per_step: 4

custom:
  extra:
    rollout_matching:
      rollout_backend: hf
      # Step-budgeted mode does packing inside the optimizer step; keep micro scope.
      post_rollout_pack_scope: micro
      decoding:
        # Exercise stochastic decode + deterministic seeding context.
        temperature: 0.7
        top_p: 1.0
        top_k: -1
      # Keep rollout short for smoke so we can complete a few optimizer steps quickly.
      max_new_tokens: 512
