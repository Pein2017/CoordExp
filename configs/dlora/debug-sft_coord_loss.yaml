extends: sft_base.yaml

# Debug/tiny dataset smoke: keep packed length short for speed and FlashAttention2 stability.
global_max_length: 2048

model:
  model: output/12-4/coord_offset_merged_ck777
  attn_impl: flash_attention_2

training:
  # Override base training settings
  weight_decay: 0.0001
  learning_rate: 8.0e-5
  vit_lr: 2.0e-5
  aligner_lr: 4.0e-5
  num_train_epochs: 1
  # max_steps: 3
  optimizer: multimodal
  output_dir: ./output/smoke/
  run_name: smoke-debug-softce_w1-tiny-len4096
  logging_dir: ./tb/smoke/debug_softce_w1_tiny_len4096
  save_strategy: "no"
  logging_steps: 1
  eval_steps: 10
  # Packing yields one packed sample per device; effective_batch_size=128 with world_size=4
  # and per-device=1 targets ~117 base samples/update with avg ~9.7 samples per pack (post-merge).
  per_device_train_batch_size: 1
  per_device_eval_batch_size: 1
  effective_batch_size: 32
  # Packing knobs (mirrors tests/packed_tiny)
  packing_buffer: 256
  packing_min_fill_ratio: 0.7
  packing_drop_last: true
  eval_packing: true

custom:
  train_jsonl: public_data/lvis/rescale_32_768_poly_20/train_tiny.coord.jsonl
  val_jsonl: public_data/lvis/rescale_32_768_poly_20/val_tiny.coord.jsonl
  token_type_metrics:
    enabled: true
    include: ["dataset", "default", "lvis"]
  # Logs/dumps the exact batch metadata when loss spikes or logits go non-finite.
  # Uses `base_idx`/`sample_id` to let you locate the offending JSONL record quickly.
  instability_monitor:
    enabled: true
    max_meta_samples: 16
    ema_decay: 0.98
    spike_factor: 8.0
    abs_loss_threshold: 0.2
    min_supervised_tokens: 64
    dump_samples: true
    early_stop:
      enabled: true
      on_reasons: ["zero_token_acc"]
    guard:
      enabled: true
      guard_in_eval: false
      guard_on_nonfinite: true
      guard_on_spike: true
      guard_on_zero_acc: true
      min_token_acc: 0.01
      max_abs_logit: 200.0
  # Mirror python logging (and optionally stdout/stderr) to output_dir for quick review.
  log_file:
    enabled: true
    filename: train.log
    capture_stdout: false
    capture_stderr: false
  coord_soft_ce_w1:
    enabled: true
    soft_ce_weight: 1.0
    w1_weight: 1.0
    gate_weight: 1.0
    temperature: 1.0
    target_sigma: 2.0
    target_truncate: 16
