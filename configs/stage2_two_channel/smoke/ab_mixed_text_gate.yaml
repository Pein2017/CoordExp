extends: ../base.yaml

model:
  # Keep aligned with prod init for smoke parity.
  model: output/stage1/coco_bbox_max60-coco80-desc_first/epoch_4-softce_w1-coco80-ckpt_1832-merged

training:
  run_name: smoke_ab_mixed_text_gate
  output_dir: output/stage2_ab/smoke/ab_mixed_text_gate
  logging_dir: tb/stage2_ab/smoke/ab_mixed_text_gate
  effective_batch_size: 8
  logging_steps: 1
  logging_first_step: true
  eval_strategy: "no"
  save_strategy: "no"
  do_eval: false
  max_steps: 2

stage2_ab:
  schedule: {b_ratio: 0.85}
  n_softctx_iter: 2
  pipeline:
    objective:
      - name: token_ce
        enabled: true
        weight: 1.0
        channels: [A, B]
        config:
          desc_ce_weight: 1.0
          self_context_struct_ce_weight: 0.1
          rollout_fn_desc_weight: 1.0
          rollout_matched_prefix_struct_weight: 1.0
          rollout_drop_invalid_struct_ce_multiplier: 1.0
      - name: bbox_geo
        enabled: true
        weight: 1.0
        channels: [A, B]
        config:
          smoothl1_weight: 2.0
          ciou_weight: 0.2
      - name: coord_reg
        enabled: true
        weight: 1.0
        channels: [A, B]
        config:
          coord_ce_weight: 0.02
          coord_el1_weight: 0.0
          coord_ehuber_weight: 0.0
          coord_huber_delta: 0.001
          coord_entropy_weight: 0.0
          coord_gate_weight: 1.0
          text_gate_weight: 0.1
          soft_ce_weight: 0.1
          self_context_soft_ce_weight: 0.1
          w1_weight: 0.1
          temperature: 1.0
          target_sigma: 2.0
          target_truncate: 8
    diagnostics:
      - name: coord_diag
        enabled: true
        weight: 1.0
        channels: [A, B]
        config: {}

custom:
  train_sample_limit: 64
  val_sample_limit: 16

rollout_matching:
  # Runtime knobs only (keep objective pipeline aligned with prod).
  max_new_tokens: 256
  monitor_dump:
    enabled: false
