extends: ../prod/desc_first_a_only.yaml

# Ablation: disable Channel-A iterative self-context by setting n_softctx_iter=1.
# Notes:
# - For n_softctx_iter<=1, Channel-A self-context struct-CE stabilizer is disabled in code.
# - softctx_grad_mode / coord_ctx_embed_mode become effectively irrelevant because the
#   iterative loop does not run when n_softctx_iter=1.
#
# Loss-composition guardrails (explicit, to avoid accidental drift via inheritance):
# - bbox_geo: SmoothL1 (+ CIoU)
# - coord_reg: hardCE (coord_token_ce) + softCE + W1 + coord/text gating

training:
  run_name: epoch_2-eff_size_64-n_softctx_iter_3-a_only
  output_dir: output/stage2_ab/coco_bbox_max60/a_only_iter3
  logging_dir: tb/stage2_ab/coco_bbox_max60/a_only_iter3

stage2_ab:
  schedule:
    b_ratio: 0.0
  n_softctx_iter: 3
  pipeline:
    objective:
      - name: token_ce
        enabled: true
        weight: 1.0
        channels: [A, B]
        config:
          desc_ce_weight: 1.0
          self_context_struct_ce_weight: 0.1
          rollout_fn_desc_weight: 1.0
          rollout_matched_prefix_struct_weight: 1.0
          rollout_drop_invalid_struct_ce_multiplier: 1.0
      - name: bbox_geo
        enabled: true
        weight: 1.0
        channels: [A, B]
        config:
          # Required: SmoothL1 on decoded bbox geometry.
          smoothl1_weight: 2.0
          ciou_weight: 0.2
          a1_smoothl1_weight: 0.0
          a1_ciou_weight: 0.0
      - name: coord_reg
        enabled: true
        weight: 1.0
        channels: [A, B]
        config:
          # Required: hard CE on coord-token bins (coord tokens are NOT covered by text/struct CE).
          coord_ce_weight: 0.02
          coord_el1_weight: 0.0
          coord_ehuber_weight: 0.0
          coord_huber_delta: 0.001
          coord_entropy_weight: 0.0
          # Required: gating at coord-token positions.
          coord_gate_weight: 1.0
          text_gate_weight: 0.1
          # Required: distribution losses at coord-token positions.
          soft_ce_weight: 0.1
          self_context_soft_ce_weight: 0.1
          w1_weight: 0.1
          a1_soft_ce_weight: 0.0
          a1_w1_weight: 0.0
          temperature: 1.0
          target_sigma: 2.0
          target_truncate: 8
    diagnostics:
      - name: coord_diag
        enabled: true
        weight: 1.0
        channels: [A, B]
        config: {}
