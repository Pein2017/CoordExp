extends: ../base.yaml

# Stage-2 Rollout-Aligned Teacher Forcing (stage2_rollout_aligned).
#
# Contract:
# - `custom.trainer_variant: stage2_rollout_aligned`
# - `rollout_matching.pipeline` is REQUIRED.
# - `stage2_ab.pipeline` is NOT allowed for this trainer variant.

training:
  # Rollout-heavy trainer; keep per-device small by default.
  per_device_train_batch_size: 1
  per_device_eval_batch_size: 2
  # Not strictly required for rollout-aligned, but keeps parity with other Stage-2 runs.
  effective_batch_size: 8

  # Post-rollout packing (trainer-managed).
  packing: true
  packing_buffer: 256
  packing_min_fill_ratio: 0.7
  packing_drop_last: true
  # eval_packing is ignored for rollout-aligned (trainer handles collation), but keep true.
  eval_packing: true

  # Rollout-aligned eval runs full rollout->parse->Hungarian-match; disable by default
  # and enable explicitly in derived configs.
  eval_strategy: "no"
  save_strategy: "no"

  metric_for_best_model: rollout/f1
  greater_is_better: true

  optimizer: multimodal
  learning_rate: 2.0e-5
  vit_lr: 2.0e-5
  aligner_lr: 2.0e-5
  weight_decay: 0.0

custom:
  trainer_variant: stage2_rollout_aligned
  train_sample_limit: null
  val_sample_limit: null
  coord_tokens:
    enabled: true
    skip_bbox_norm: true

rollout_matching:
  # Default to HF backend for portability and trusted traces.
  rollout_backend: hf
  decode_batch_size: 2
  coord_decode_mode: exp
  decode_mode: greedy
  max_new_tokens: 512
  decoding:
    temperature: 0.0
    top_p: 1.0
    top_k: -1
  repetition_penalty: 1.1

  candidate_top_k: 5
  maskiou_gate: 0.3
  maskiou_resolution: 256
  fp_cost: 0.5
  fn_cost: 2

  eval_detection:
    enabled: false
    metrics: coco
    use_segm: false
    strict_parse: true
    score_mode: constant
    constant_score: 1.0
    pred_score_source: eval_rollout_constant
    pred_score_version: 2

  pipeline:
    objective:
      - name: token_ce
        enabled: true
        weight: 1.0
        channels: [A, B]
        config:
          desc_ce_weight: 1.0
          # Not used by rollout-aligned teacher forcing (no self_context surface),
          # but kept explicit for allowlist completeness.
          self_context_struct_ce_weight: 0.0
          rollout_fn_desc_weight: 1.0
          rollout_matched_prefix_struct_weight: 1.0
          rollout_drop_invalid_struct_ce_multiplier: 1.0
      - name: bbox_geo
        enabled: true
        weight: 1.0
        channels: [A, B]
        config:
          smoothl1_weight: 2.0
          ciou_weight: 0.5
          # Optional Channel-A A1 anchor ablations (keep explicit for allowlist completeness).
          a1_smoothl1_weight: 0.0
          a1_ciou_weight: 0.0
      - name: coord_reg
        enabled: true
        weight: 1.0
        channels: [A, B]
        config:
          coord_ce_weight: 0.0
          coord_el1_weight: 0.0
          coord_ehuber_weight: 0.0
          coord_huber_delta: 0.001
          coord_entropy_weight: 0.0
          coord_gate_weight: 1.0
          text_gate_weight: 0.0
          soft_ce_weight: 0.02
          self_context_soft_ce_weight: 0.0
          w1_weight: 0.02
          # Optional Channel-A A1 anchor ablations (keep explicit for allowlist completeness).
          a1_soft_ce_weight: 0.0
          a1_w1_weight: 0.0
          temperature: 1.0
          target_sigma: 2.0
          target_truncate: null
    diagnostics:
      - name: coord_diag
        enabled: true
        weight: 1.0
        channels: [A, B]
        config: {}
